@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using ROH.Site.Interfaces.Helpers
@inherits LayoutComponentBase
@inject NavigationManager Navigation;
@inject ICustomAuthenticationStateProvider CustomAuthStateProvider
@inject AuthenticationStateProvider AuthenticationStateProvider

@* Required *@
<MudThemeProvider Theme="@RohTheme.Dark" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Class="roh-appbar">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />

        <MudText Typo="Typo.h6"
                 Color="Color.Inherit"
                 Class="roh-appbar-title">
            Reign of Humanae
        </MudText>

        <MudSpacer />

        <MudIconButton Icon="@Icons.Material.Filled.AccountCircle"
                       Color="Color.Inherit"
                       OnClick="@(() => Navigation.NavigateTo("/login"))" />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen"
               Variant="DrawerVariant.Temporary"
               Class="roh-drawer">

        <!-- Drawer content later -->
        <MudNavMenu Class="roh-navmenu">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
                Home
            </MudNavLink>
            <MudNavGroup Title="Account" Icon="@Icons.Material.Filled.AccountCircle">
                <MudNavLink Href="/login" Icon="@Icons.Material.Filled.Login">
                    Login
                </MudNavLink>
                <MudNavLink Href="/createaccount" Icon="@Icons.Material.Filled.PersonAdd">
                    Create Account
                </MudNavLink>
            </MudNavGroup>
            <MudNavGroup Title="Lore" Icon="@Icons.Material.Filled.MenuBook">
                <MudNavLink Href="/lore" Icon="@Icons.Material.Filled.AutoStories">
                    Lore
                </MudNavLink>
                <MudNavLink Href="/races" Icon="@Icons.Material.Filled.Groups">
                    Races
                </MudNavLink>
                <MudNavLink Href="/crafting" Icon="@Icons.Material.Filled.Handyman">
                    Crafting
                </MudNavLink>
                <MudNavLink Href="/magic-skills" Icon="@Icons.Material.Filled.AutoFixHigh">
                    Magic Skills
                </MudNavLink>
                <MudNavLink Href="/world-bosses" Icon="@Icons.Material.Filled.Public">
                    World Bosses
                </MudNavLink>
            </MudNavGroup>
            <MudNavGroup Title="Manager" Icon="@Icons.Material.Filled.Build">
                <MudNavLink Href="/manager/version/versionmanager" Icon="@Icons.Material.Filled.Settings">
                    Version Manager
                </MudNavLink>
            </MudNavGroup>
            <MudNavLink Href="/test" Icon="@Icons.Material.Filled.Science">
                Test
            </MudNavLink>
        </MudNavMenu>

    </MudDrawer>

    <MudMainContent Class="roh-content">
        @Body
    </MudMainContent>

</MudLayout>

@code {
    private bool _drawerOpen;

    void ToggleDrawer()
        => _drawerOpen = !_drawerOpen;

    private bool IsAuthorized { get; set; } = false;


    protected override async Task OnInitializedAsync()
    {
        IsAuthorized = !string.IsNullOrWhiteSpace(await CustomAuthStateProvider.GetToken());
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            CustomAuthStateProvider.Initialize();
            var token = await CustomAuthStateProvider.GetToken();
            IsAuthorized = !string.IsNullOrWhiteSpace(await CustomAuthStateProvider.GetToken());
            StateHasChanged();
        }
    }

}
